# 无人机摄影测量 - PnP相机参数求解算法

## 作业描述

实现空间点求相机参数的算法，求解方程：

$$\mathbf{x} = \mathbf{K}[\mathbf{R}|\mathbf{T}]\mathbf{X}$$

其中：
- $\mathbf{x}$：图像点坐标（已知）
- $\mathbf{K}$：相机内参矩阵（已知）
- $\mathbf{X}$：世界坐标系中的空间点（已知）
- $\mathbf{R}$：旋转矩阵（待求）
- $\mathbf{T}$：平移向量（待求）

## 算法原理

### 第一步：求解线性方程（DLT方法）

1. **归一化图像坐标**：使用 $\mathbf{K}^{-1}$ 去除内参影响
   $$\mathbf{x}_{norm} = \mathbf{K}^{-1}\mathbf{x}$$

2. **构建线性方程组**：将投影方程展开为线性形式
   - 对于每个点对应关系，构建2个方程
   - $n$ 个点产生 $2n$ 个方程，求解12个未知数（$[\mathbf{R}|\mathbf{T}]$ 矩阵的元素）
   
3. **SVD求解**：求解 $\mathbf{A}\mathbf{m} = 0$
   - $\mathbf{m}$ 是 $[\mathbf{R}|\mathbf{T}]$ 矩阵展开的12维向量
   - 解为 $\mathbf{A}$ 的右奇异向量（对应最小奇异值）

### 第二步：矩阵分解

1. **提取旋转和平移**：从求解的 $3 \times 4$ 矩阵中分离
   - 前 $3 \times 3$ 部分为旋转矩阵近似值
   - 最后一列为平移向量

2. **正交化处理**：对旋转矩阵进行SVD分解
   - $\mathbf{R}_{approx} = \mathbf{U}\mathbf{\Sigma}\mathbf{V}^T$
   - $\mathbf{R} = \mathbf{U}\mathbf{V}^T$（强制为正交矩阵）
   - 检查行列式确保右手坐标系（$\det(\mathbf{R}) = 1$）

## 文件说明

### 1. `pnp_solver.cpp`
主算法实现文件，包含：
- **Matrix类**：矩阵基本运算（乘法、转置、求逆）
- **SVD类**：奇异值分解（基于Jacobi方法）
- **PnPSolver类**：PnP问题求解器
  - `solve()`: 主求解函数
  - `enforceOrthogonality()`: 正交化处理
- **验证函数**：计算重投影误差
- **主函数**：包含基本测试示例

### 2. `test_pnp.cpp`
完整测试套件，包含5个测试用例：
1. **测试1**：立方体顶点（理想情况）
2. **测试2**：平面点配置
3. **测试3**：带噪声观测（标准差1.0像素）
4. **测试4**：最少点数（6个点）
5. **测试5**：大角度旋转（60度）

### 3. `CMakeLists.txt`
CMake构建配置文件

## 编译与运行

### 方法1：使用CMake（推荐）

```bash
# 创建构建目录
mkdir build
cd build

# 配置并编译
cmake ..
make

# 运行主程序
./bin/pnp_solver

# 运行测试套件
./bin/test_pnp
```

### 方法2：直接使用g++

```bash
# 编译主程序
g++ -o pnp_solver pnp_solver.cpp -std=c++11 -O2 -lm

# 编译测试程序
g++ -o test_pnp test_pnp.cpp -std=c++11 -O2 -lm

# 运行
./pnp_solver
./test_pnp
```

## 算法特点

### 优点
1. **完全自主实现**：未使用OpenCV等现成PnP函数
2. **纯C++实现**：不依赖第三方矩阵库（Eigen等）
3. **数学推导清晰**：严格按照DLT+分解两步法
4. **鲁棒性好**：通过SVD分解保证数值稳定性

### 技术细节
- **最少点数**：至少需要6个非共面点
- **线性求解**：使用DLT方法转化为线性最小二乘问题
- **正交约束**：通过SVD分解强制旋转矩阵满足正交性
- **尺度恢复**：通过归一化保持正确的尺度关系

## 输出示例

程序会输出：
1. 输入的相机内参矩阵 $\mathbf{K}$
2. 真实的旋转矩阵 $\mathbf{R}$ 和平移向量 $\mathbf{T}$（测试用）
3. 生成的图像点坐标
4. 求解得到的 $\mathbf{R}$ 和 $\mathbf{T}$
5. 每个点的重投影误差
6. 平均重投影误差
7. 与真实值的差异对比

典型输出误差：
- 理想情况（无噪声）：重投影误差 < $10^{-6}$ 像素
- 带噪声情况：重投影误差约等于输入噪声水平

## 理论依据

该实现基于以下理论：
1. **透视投影模型**：针孔相机模型
2. **DLT算法**：Direct Linear Transform
3. **SVD分解**：奇异值分解求解最小二乘
4. **正交矩阵性质**：旋转矩阵的正交约束

## 注意事项

1. **点配置要求**：
   - 至少6个点
   - 避免所有点共面（退化配置）
   - 点应尽量分布在不同深度

2. **数值稳定性**：
   - 世界坐标和图像坐标应进行适当归一化
   - 避免极端的尺度差异
   - 相机不应过于接近或远离目标

3. **坐标系定义**：
   - 采用右手坐标系
   - 相机坐标系：Z轴指向前方（深度方向）
   - 旋转矩阵行列式为+1

## 作业提交清单

✅ 源代码（C++实现）
✅ 未直接调用OpenCV PnP函数
✅ 包含线性方程求解步骤
✅ 包含矩阵分解步骤
✅ 提供完整测试用例
✅ 包含验证和误差分析

## 参考文献

1. Hartley, R., & Zisserman, A. (2003). Multiple View Geometry in Computer Vision
2. 张正友. (2000). A flexible new technique for camera calibration
3. Lepetit, V., et al. (2009). EPnP: An Accurate O(n) Solution to the PnP Problem

---

**作者**: [您的姓名]  
**课程**: 摄影测量与遥感工程  
**日期**: 2025年12月15日
